@page "/live"
@namespace ReserveMe.Pages.Tables

<PageTitle>Live Venue</PageTitle>

<div class="container-fluid py-4">

    @* Header *@
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h4 class="fw-bold mb-1">Table Management</h4>
            <p class="text-muted mb-0">View and manage tables in the restaurant</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-wave" @onclick="() => OpenReserveTableDialog(null)">
                <i class="bi bi-calendar-plus me-1"></i> Reserve Table
            </button>
            <button class="btn btn-primary btn-wave" @onclick="OpenAddTableDialog">
                <i class="bi bi-plus-circle me-1"></i> Add Table
            </button>
        </div>
    </div>

    @* Statistics *@
    <div class="row g-3 mb-4">
        <div class="col-6 col-sm-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #424242, #616161);">
                <div class="card-body">
                    <h3 class="fw-bold mb-0">@_tables.Count</h3>
                    <small class="opacity-75">Total tables</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #388E3C, #4CAF50);">
                <div class="card-body">
                    <h3 class="fw-bold mb-0">@_tables.Count(t => t.Status == TableStatus.Available && t.IsActive)</h3>
                    <small class="opacity-75">Available</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #D32F2F, #F44336);">
                <div class="card-body">
                    <h3 class="fw-bold mb-0">@_tables.Count(t => t.Status == TableStatus.Occupied)</h3>
                    <small class="opacity-75">Occupied</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #F57C00, #FF9800);">
                <div class="card-body">
                    <h3 class="fw-bold mb-0">@_tables.Count(t => t.Status == TableStatus.Reserved)</h3>
                    <small class="opacity-75">Reserved</small>
                </div>
            </div>
        </div>
    </div>

    @* Filters *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn @(_statusFilter == null && _activeFilter == null ? "btn-primary" : "btn-outline-secondary")"
                        @onclick="() => { _statusFilter = null; _activeFilter = null; }">
                    All
                </button>
                <button class="btn @(_statusFilter == TableStatus.Available ? "btn-success" : "btn-outline-success")"
                        @onclick="() => _statusFilter = TableStatus.Available">
                    <i class="bi bi-check-circle me-1"></i> Available
                </button>
                <button class="btn @(_statusFilter == TableStatus.Occupied ? "btn-danger" : "btn-outline-danger")"
                        @onclick="() => _statusFilter = TableStatus.Occupied">
                    <i class="bi bi-people me-1"></i> Occupied
                </button>
                <button class="btn @(_statusFilter == TableStatus.Reserved ? "btn-warning" : "btn-outline-warning")"
                        @onclick="() => _statusFilter = TableStatus.Reserved">
                    <i class="bi bi-calendar-event me-1"></i> Reserved
                </button>

                <div class="vr mx-2"></div>

                <button class="btn @(_activeFilter == true ? "btn-success" : "btn-outline-secondary")"
                        @onclick="() => _activeFilter = _activeFilter == true ? null : true">
                    <i class="bi bi-eye me-1"></i> Active only
                </button>
                <button class="btn @(_activeFilter == false ? "btn-secondary" : "btn-outline-secondary")"
                        @onclick="() => _activeFilter = _activeFilter == false ? null : false">
                    <i class="bi bi-eye-slash me-1"></i> Inactive only
                </button>
            </div>
        </div>
    </div>

    @* Tables Grid *@
    <div class="row g-3">
        @foreach (var table in FilteredTables)
        {
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <div class="card table-card @GetTableCardClass(table)"
                     @onclick="() => SelectTable(table)"
                     style="cursor: pointer;">
                    <div class="card-body text-center p-3">
                        <i class="bi bi-table fs-1" style="color: @GetStatusColor(table.Status);"></i>
                        <h6 class="mt-2 mb-1">Table #@table.TableNumber</h6>
                        <span class="badge @GetStatusBadgeClass(table.Status)">
                            @GetStatusText(table.Status)
                        </span>
                        <div class="mt-2 text-muted small">
                            <i class="bi bi-people"></i>
                            @if (table.Status == TableStatus.Reserved && table.GuestCount.HasValue)
                            {
                                @table.GuestCount.Value
                            }
                            else
                            {
                                @table.Capacity
                            }
                            seats
                        </div>
                        @if (!table.IsActive)
                        {
                            <span class="badge bg-secondary mt-1">Inactive</span>
                        }
                    </div>
                </div>
            </div>
        }

        @if (!FilteredTables.Any())
        {
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-table fs-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">No tables found</h5>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@* Details Drawer (Offcanvas) *@
@if (_detailsDrawerOpen && _selectedTable != null)
{
    <div class="offcanvas-backdrop fade show" @onclick="() => _detailsDrawerOpen = false"></div>
    <div class="offcanvas offcanvas-end show" tabindex="-1" style="visibility: visible;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Table #@_selectedTable.TableNumber</h5>
            <button type="button" class="btn-close" @onclick="() => _detailsDrawerOpen = false"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="list-group list-group-flush mb-4">
                <li class="list-group-item d-flex justify-content-between">
                    <span><i class="bi bi-hash me-2"></i>Number</span>
                    <strong>@_selectedTable.TableNumber</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-circle-fill me-2" style="color: @GetStatusColor(_selectedTable.Status);"></i>Status</span>
                    <span class="badge @GetStatusBadgeClass(_selectedTable.Status)">@GetStatusText(_selectedTable.Status)</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span><i class="bi bi-people me-2"></i>Capacity</span>
                    <strong>@_selectedTable.Capacity seats</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-check-circle me-2"></i>Active</span>
                    <span class="badge @(_selectedTable.IsActive ? "bg-success" : "bg-secondary")">
                        @(_selectedTable.IsActive ? "Yes" : "No")
                    </span>
                </li>
            </ul>

            @* Reservation Details (read-only) *@
            @if (_selectedTable.Status == TableStatus.Reserved && _selectedTable.ActiveReservationId.HasValue)
            {
                <h6 class="fw-bold mb-3">Reservation details</h6>
                <ul class="list-group list-group-flush mb-4">
                    @if (!string.IsNullOrEmpty(_selectedTable.CustomerName))
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-person me-2"></i>Customer</span>
                            <strong>@_selectedTable.CustomerName</strong>
                        </li>
                    }
                    @if (!string.IsNullOrEmpty(_selectedTable.CustomerPhone))
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-telephone me-2"></i>Phone</span>
                            <strong>@_selectedTable.CustomerPhone</strong>
                        </li>
                    }
                    @if (_selectedTable.ReservationDate.HasValue)
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-calendar me-2"></i>Date</span>
                            <strong>@_selectedTable.ReservationDate.Value.ToString("dd.MM.yyyy")</strong>
                        </li>
                    }
                    @if (_selectedTable.ReservationTime.HasValue)
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-clock me-2"></i>Time</span>
                            <strong>@_selectedTable.ReservationTime.Value.ToString(@"hh\:mm")</strong>
                        </li>
                    }
                    @if (_selectedTable.GuestCount.HasValue)
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-people me-2"></i>Guests</span>
                            <strong>@_selectedTable.GuestCount.Value</strong>
                        </li>
                    }
                </ul>
            }
        </div>
        <div class="offcanvas-footer p-3 border-top">
            <div class="d-grid gap-2">
                @if (_selectedTable.Status == TableStatus.Available && _selectedTable.IsActive)
                {
                    <button class="btn btn-primary" @onclick="() => OpenReserveTableDialog(_selectedTable)">
                        <i class="bi bi-calendar-plus me-2"></i>Reserve Table
                    </button>
                }

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary flex-grow-1" @onclick="OpenEditTableDialog">
                        <i class="bi bi-pencil me-2"></i>Edit
                    </button>
                    @if (_selectedTable.Status == TableStatus.Available)
                    {
                        <button class="btn btn-outline-danger" @onclick="OpenDeleteConfirmation">
                            <i class="bi bi-trash"></i>
                        </button>
                    }
                </div>

                <button class="btn @(_selectedTable.IsActive ? "btn-outline-secondary" : "btn-outline-success")" @onclick="ToggleTableActive">
                    <i class="bi @(_selectedTable.IsActive ? "bi-eye-slash" : "bi-eye") me-2"></i>
                    @(_selectedTable.IsActive ? "Deactivate" : "Activate")
                </button>
            </div>
        </div>
    </div>
}

@* Table Dialog (Add/Edit) *@
@if (_tableDialogOpen)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(_isEditMode ? "Edit Table" : "Add New Table")</h5>
                    <button type="button" class="btn-close" @onclick="() => _tableDialogOpen = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Table Number</label>
                        <input type="number" class="form-control" @bind="_editingTable.TableNumber" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Capacity (Seats)</label>
                        <input type="number" class="form-control" @bind="_editingTable.Capacity" />
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" @bind="_editingTable.IsActive" id="isActiveCheck">
                        <label class="form-check-label" for="isActiveCheck">
                            Is Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" @onclick="() => _tableDialogOpen = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTable">Save Table</button>
                </div>
            </div>
        </div>
    </div>
}

@* Reservation Dialog *@
@if (_reserveDialogOpen)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @( _selectedTable != null ? $"New Reservation - Table #{_selectedTable.TableNumber}" : "New Reservation" )
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => _reserveDialogOpen = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Table</label>
                        @if (_selectedTable != null)
                        {
                            <input type="text" class="form-control" value="Table #@_selectedTable.TableNumber" disabled />
                        }
                        else
                        {
                            <select class="form-select" @bind="_reservationTableNumber">
                                <option value="0">Auto-assign table</option>
                                @foreach (var t in _tables.Where(t => t.IsActive && t.Status == TableStatus.Available))
                                {
                                    <option value="@t.TableNumber">Table #@t.TableNumber (Capacity: @t.Capacity)</option>
                                }
                            </select>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" @bind="_reservationCustomerName" placeholder="Enter name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" @bind="_reservationPhoneNumber" placeholder="Enter phone" />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" @bind="_reservationDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time</label>
                            <input type="time" class="form-control" value="@_reservationTimeString" @onchange="OnTimeChanged" />
                        </div>
                    </div>
                    <div class="mb-3">
                        @{
                            int maxCapacity = _selectedTable?.Capacity ?? (_tables.FirstOrDefault(t => t.TableNumber == _reservationTableNumber)?.Capacity ?? 0);
                            if (maxCapacity == 0 && _reservationTableNumber == 0) maxCapacity = _tables.Any() ? _tables.Max(t => t.Capacity) : 10;
                        }
                        <label class="form-label">Guests Count (Max @maxCapacity)</label>
                        <input type="number" class="form-control" @bind="_reservationGuestCount" min="1" max="@maxCapacity" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" @onclick="() => _reserveDialogOpen = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmReservation">Confirm Reservation</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation *@
@if (_deleteDialogOpen)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Delete Table?</h5>
                    <button type="button" class="btn-close" @onclick="() => _deleteDialogOpen = false"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-exclamation-triangle fs-1 text-danger mb-3 d-block"></i>
                    <p class="mb-0">Are you sure you want to delete Table #@(_selectedTable?.TableNumber)?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" @onclick="() => _deleteDialogOpen = false">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteTable">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .table-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .table-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
        }

    .table-card-selected {
        border: 2px solid #0d6efd !important;
        transform: scale(1.02);
    }

    .table-card-inactive {
        opacity: 0.6;
    }

    .offcanvas {
        width: 400px !important;
    }
</style>
